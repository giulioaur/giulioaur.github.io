SM.CONST.activeItemClass="sm-active",SM.CONST.lastActiveItemClass="sm-last-active",SM.CONST.inputActivationEvent="sm-activate",SM.CONST.inputDeactivationEvent="sm-deactivate",SM.CONST.noInputClass="sm-no-input",SM.CONST.inputEvent={firstFocus:0,hover:1,restoreFocus:2,leaveMenu:3,moveLeft:4,moveRight:5,moveUp:6,moveDown:7},SM.CONST.inputData=[{events:[],callback:"_goBack"},{events:[],callback:"_select"},{events:[],callback:"_goDown"},{events:[],callback:"_goLeft"},{events:[],callback:"_goUp"},{events:[],callback:"_goRight"}],SM.input={_activationEvent:new CustomEvent(SM.CONST.inputActivationEvent,{detail:{target:null,other:null,isMouseTrigger:!1,reason:""}}),_deactivationEvent:new CustomEvent(SM.CONST.inputDeactivationEvent,{detail:{target:null,other:null,isMouseTrigger:!1,reason:""}}),_clickEvent:new MouseEvent("click"),_graph:null,_activeItem:null,_cachedItems:{},_options:{firstFocus:!1,dynamicMenu:!1},_wasKeyboard:!1,get wasKeyboard(){return this._wasKeyboard},bindInput(t,e,s={},i=document){const a=this;if(this._graph=t,this._setupOptions(s),this._setupInputMap(e),this._graph){i.addEventListener("keydown",(t=>{for(let e of SM.CONST.inputData)e.events.includes(t.which)&&this[e.callback].call(this)}));const t=document.querySelectorAll(`.${SM.CONST.itemClass}:not(.${SM.CONST.noInputClass})`);for(let e of t)e.addEventListener("mouseenter",(function(){a._changeActive(this,!0,SM.CONST.inputEvent.hover)}));this._graph.addDataCallback(((t,e)=>this._cleanMenu(e)),!0),this._options.firstFocus&&this._changeActive(this._getItems()[0],!1,SM.CONST.inputEvent.firstFocus)}else console.error("No valid graph for input.")},_cleanMenu(t){const e=t.getElementsByClassName(SM.CONST.activeItemClass);for(let t of e)this._changeEventDetails(this._deactivationEvent,t,null,!1,SM.CONST.inputEvent.leaveMenu),t.dispatchEvent(this._deactivationEvent),t==this._activeItem&&(this._activeItem=null);return!0},setFocusOn(t,e=0,s=!1,i=SM.CONST.inputEvent.firstFocus){t||(t=this._graph._current);const a=e instanceof HTMLElement?e:t.getElementsByClassName(SM.CONST.itemClass)[parseInt(e)];if(a){const e=t.querySelector(`.${SM.CONST.lastActiveItemClass}`);e&&e.classList.remove(SM.CONST.lastActiveItemClass),this._changeActive(a,s,i)}},saveFocus(t,e=null){t||(t=this._graph._current),e||(e=t.querySelector(`.${SM.CONST.activeItemClass}`)),e&&e.classList.add(SM.CONST.lastActiveItemClass)},restoreFocus(t,e=!1){t||(t=this._graph._current);const s=t.querySelector(`.${SM.CONST.lastActiveItemClass}`);s?(s.classList.remove(SM.CONST.lastActiveItemClass),this._changeActive(s,e,SM.CONST.inputEvent.restoreFocus)):this.setFocusOn(t,0,e,SM.CONST.inputEvent.restoreFocus)},_setupOptions(t){t&&!0===t.firstFocus&&(this._options.firstFocus=!0),t&&!0===t.dynamicMenu&&(this._options.dynamicMenu=!0)},_setupInputMap(t){SM.CONST.inputData[0].events=t.back,SM.CONST.inputData[1].events=t.select,SM.CONST.inputData[2].events=t.down,SM.CONST.inputData[3].events=t.left,SM.CONST.inputData[4].events=t.up,SM.CONST.inputData[5].events=t.right},_changeActive(t,e,s){if(this._activeItem!=t){if(this._activeItem){this._changeEventDetails(this._deactivationEvent,this._activeItem,t,e,s);const i=this._activeItem;this._activeItem.classList.remove(SM.CONST.activeItemClass),this._activeItem=null,i.dispatchEvent(this._deactivationEvent)}t?(t.classList.add(SM.CONST.activeItemClass),this._changeEventDetails(this._activationEvent,t,this._activeItem,e,s),this._activeItem=t,t.dispatchEvent(this._activationEvent)):t||(this._activeItem=t)}},_goBack(){this._wasKeyboard=!0,this._graph.goto("",!0),this._wasKeyboard=!1},_select(){this._wasKeyboard=!0,this._activeItem.dispatchEvent(this._clickEvent),this._wasKeyboard=!1},_goDown(){this._move(0,1)},_goUp(){this._move(0,-1)},_goRight(){this._move(1,0)},_goLeft(){this._move(-1,0)},_move(t,e){const s=t?t>0?SM.CONST.inputEvent.moveLeft:SM.CONST.inputEvent.moveRight:e>0?SM.CONST.inputEvent.moveDown:SM.CONST.inputEvent.moveLeft;if(this._activeItem){const i=this._getAbsolutePos(this._activeItem),a=Array.from(this._getItems()).map((t=>({bb:this._getAbsolutePos(t),element:t}))).filter((s=>t?t>0?s.bb.left>=i.right:s.bb.right<=i.left:e>0?s.bb.top>=i.bottom:s.bb.bottom<=i.top)).filter((e=>t?Math.abs(e.bb.top-i.top)<=Math.max(e.bb.height,i.height):Math.abs(e.bb.left-i.left)<=Math.max(e.bb.width,i.width))).sort(((s,a)=>{const n=t?t>0?"left":"right":e>0?"top":"bottom";let o=(a.bb[n]-s.bb[n])*-(t||e);return o>-.5&&o<.5&&(o=0),o||(t?Math.abs(s.bb.top-i.top)-Math.abs(a.bb.top-i.top):Math.abs(s.bb.left-i.left)-Math.abs(a.bb.left-i.left))}));a.length>0&&this._changeActive(a[0].element,!1,s)}else this._changeActive(this._graph._current.querySelector(`.${this._graph._getLayoutName(this._graph._current.id)} .${SM.CONST.itemClass}:not(.${SM.CONST.noInputClass})`),!1,s)},_getItems(){const t=this._graph._current.id,e=this._graph._getLayoutName(t);return this._options.dynamicMenu&&(this._cachedItems.items=document.querySelectorAll(`#${t} .${e} .${SM.CONST.itemClass}:not(.${SM.CONST.noInputClass})`)),this._cachedItems.menuId&&this._cachedItems.menuId==t&&this._cachedItems.layout==e||(this._cachedItems.items=document.querySelectorAll(`#${t} .${e} .${SM.CONST.itemClass}:not(.${SM.CONST.noInputClass})`),this._cachedItems.menuId=t,this._cachedItems.layout=e),this._cachedItems.items},_getAbsolutePos(t){const e=t.getBoundingClientRect();return{top:e.top+window.pageYOffset,bottom:e.bottom+window.pageYOffset,right:e.right+window.pageXOffset,left:e.left+window.pageXOffset,width:e.width,height:e.height}},_changeEventDetails(t,e,s,i,a){t.detail.target=e,t.detail.other=s,t.detail.isMouseTrigger=i,t.detail.reason=a}};